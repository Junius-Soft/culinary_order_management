name: Deploy Frappe to EC2 (Fixed Exit Codes)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CULLINAR_ERP_EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.CULLINAR_ERP_EC2_SSH_KEY }}
        port: 22
        command_timeout: 45m
        script: |
          #!/bin/bash
          # DO NOT use set -e here - we handle errors manually
          set -o pipefail

          # Redirect all output
          exec > >(tee -a /home/ubuntu/deploy.log)
          exec 2>&1

          echo "==================================="
          echo "üöÄ Starting Frappe Deployment"
          echo "üìÖ Date: $(date)"
          echo "==================================="

          # --------------------------------------------------
          # Initialize success flag
          # --------------------------------------------------
          DEPLOYMENT_SUCCESS=true
          DEPLOYMENT_EXIT_CODE=0

          # --------------------------------------------------
          # Prevent parallel deployments
          # --------------------------------------------------
          LOCK_FILE="/tmp/frappe_deploy.lock"
          exec 9>"$LOCK_FILE"
          
          if ! flock -n 9; then
            echo "‚ùå Another deployment is running"
            exit 1
          fi

          # Cleanup function
          cleanup() {
            flock -u 9 2>/dev/null || true
          }
          
          trap cleanup EXIT INT TERM

          # --------------------------------------------------
          # Error handler
          # --------------------------------------------------
          handle_error() {
            local exit_code=$1
            local step_name="$2"
            
            echo ""
            echo "‚ùå Error in step: $step_name"
            echo "Exit code: $exit_code"
            
            DEPLOYMENT_SUCCESS=false
            DEPLOYMENT_EXIT_CODE=$exit_code
          }

          # --------------------------------------------------
          # Retry helper
          # --------------------------------------------------
          retry() {
            local retries=$1
            local wait_time=$2
            shift 2
            local cmd="$*"

            for ((i=1; i<=retries; i++)); do
              echo "‚ñ∂Ô∏è  Attempt $i/$retries: $cmd"
              
              if eval "$cmd"; then
                echo "‚úÖ Command succeeded"
                return 0
              fi

              local last_exit_code=$?
              echo "‚ö†Ô∏è  Command failed with exit code: $last_exit_code"
              
              if [ "$i" -lt "$retries" ]; then
                echo "‚è≥ Waiting $wait_time seconds..."
                sleep "$wait_time"
              fi
            done

            echo "‚ùå Command failed after $retries attempts"
            return 1
          }

          # --------------------------------------------------
          # Pull latest code
          # --------------------------------------------------
          echo ""
          echo "üì• Pulling Latest Code"
          echo "-----------------------------------"
          
          APP_DIR="/home/ubuntu/frappe-bench-test/apps/culinary_order_management"
          
          if [ ! -d "$APP_DIR" ]; then
            handle_error 1 "App directory not found: $APP_DIR"
            exit $DEPLOYMENT_EXIT_CODE
          fi
          
          cd "$APP_DIR"

          # Save current commit
          PREVIOUS_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
          echo "üìå Current commit: $PREVIOUS_COMMIT"

          # Fetch and pull
          if git remote | grep -q "upstream"; then
            if ! retry 3 10 "git fetch upstream"; then
              echo "‚ö†Ô∏è  Upstream fetch failed, trying origin..."
              if ! retry 3 10 "git fetch origin"; then
                handle_error $? "Git fetch"
                exit $DEPLOYMENT_EXIT_CODE
              fi
            fi
          else
            if ! retry 3 10 "git fetch origin"; then
              handle_error $? "Git fetch"
              exit $DEPLOYMENT_EXIT_CODE
            fi
          fi

          if ! git checkout main; then
            handle_error $? "Git checkout"
            exit $DEPLOYMENT_EXIT_CODE
          fi

          if git remote | grep -q "upstream"; then
            if ! git pull upstream main; then
              echo "‚ö†Ô∏è  Upstream pull failed, trying origin..."
              if ! git pull origin main; then
                handle_error $? "Git pull"
                exit $DEPLOYMENT_EXIT_CODE
              fi
            fi
          else
            if ! git pull origin main; then
              handle_error $? "Git pull"
              exit $DEPLOYMENT_EXIT_CODE
            fi
          fi

          NEW_COMMIT=$(git rev-parse HEAD)
          echo "‚úÖ Updated to commit: $NEW_COMMIT"

          # --------------------------------------------------
          # Build assets
          # --------------------------------------------------
          echo ""
          echo "üèóÔ∏è  Building Assets"
          echo "-----------------------------------"
          
          BENCH_DIR="/home/ubuntu/frappe-bench-test"
          cd "$BENCH_DIR"

          # Build with explicit exit code check
          BUILD_OUTPUT=$(timeout 10m bench build --app culinary_order_management 2>&1)
          BUILD_EXIT_CODE=$?
          
          echo "$BUILD_OUTPUT"
          
          # Check for actual build errors (not just warnings)
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            if echo "$BUILD_OUTPUT" | grep -qiE "error|fatal|failed"; then
              echo "‚ùå Build failed with errors"
              handle_error $BUILD_EXIT_CODE "Build"
              
              # Rollback
              cd "$APP_DIR"
              git checkout "$PREVIOUS_COMMIT"
              exit $DEPLOYMENT_EXIT_CODE
            else
              echo "‚ö†Ô∏è  Build exited with code $BUILD_EXIT_CODE but no critical errors found"
              echo "‚úÖ Continuing deployment..."
            fi
          else
            echo "‚úÖ Build completed successfully"
          fi

          # --------------------------------------------------
          # Run migrations
          # --------------------------------------------------
          echo ""
          echo "üß¨ Running Migrations"
          echo "-----------------------------------"
          
          cd "$BENCH_DIR"
          
          # Migrate with explicit exit code check
          MIGRATE_OUTPUT=$(timeout 10m bench --site all migrate 2>&1)
          MIGRATE_EXIT_CODE=$?
          
          echo "$MIGRATE_OUTPUT"
          
          # Check migration result
          if [ $MIGRATE_EXIT_CODE -ne 0 ]; then
            # Check if it's a real error or just informational exit
            if echo "$MIGRATE_OUTPUT" | grep -qiE "error|exception|traceback|failed" | grep -v "No migration"; then
              echo "‚ùå Migration failed with errors"
              handle_error $MIGRATE_EXIT_CODE "Migration"
              
              # Rollback
              cd "$APP_DIR"
              git checkout "$PREVIOUS_COMMIT"
              retry 2 60 "bench build --app culinary_order_management"
              exit $DEPLOYMENT_EXIT_CODE
            else
              # Check if migration actually completed
              if echo "$MIGRATE_OUTPUT" | grep -qE "Updating DocTypes.*100%|Migration complete"; then
                echo "‚ö†Ô∏è  Migration exited with code $MIGRATE_EXIT_CODE but completed successfully"
                echo "‚úÖ Continuing deployment..."
              else
                echo "‚ùå Migration status unclear"
                handle_error $MIGRATE_EXIT_CODE "Migration"
                cd "$APP_DIR"
                git checkout "$PREVIOUS_COMMIT"
                exit $DEPLOYMENT_EXIT_CODE
              fi
            fi
          else
            echo "‚úÖ Migration completed successfully"
          fi

          # --------------------------------------------------
          # Clear cache
          # --------------------------------------------------
          echo ""
          echo "üßπ Clearing Cache"
          echo "-----------------------------------"
          
          # Cache clear can fail without affecting deployment
          if bench --site all clear-cache 2>&1; then
            echo "‚úÖ Cache cleared"
          else
            echo "‚ö†Ô∏è  Cache clear failed, but continuing..."
          fi

          # --------------------------------------------------
          # Restart services
          # --------------------------------------------------
          echo ""
          echo "üîÅ Restarting Services"
          echo "-----------------------------------"
          
          if bench restart 2>&1; then
            echo "‚úÖ Services restarted via bench"
          else
            echo "‚ö†Ô∏è  bench restart failed, trying supervisor..."
            if sudo supervisorctl restart all 2>&1; then
              echo "‚úÖ Services restarted via supervisor"
            else
              handle_error $? "Service restart"
              exit $DEPLOYMENT_EXIT_CODE
            fi
          fi

          echo "‚è≥ Waiting for services to stabilize..."
          sleep 10

          # --------------------------------------------------
          # Health check
          # --------------------------------------------------
          echo ""
          echo "üè• Health Check"
          echo "-----------------------------------"
          
          echo "üìä Supervisor status:"
          SUPERVISOR_STATUS=$(sudo supervisorctl status 2>&1)
          echo "$SUPERVISOR_STATUS"
          
          # Check for critical failures
          if echo "$SUPERVISOR_STATUS" | grep -qE "FATAL|EXITED"; then
            echo "‚ùå Critical services are down"
            echo "$SUPERVISOR_STATUS" | grep -E "FATAL|EXITED"
            handle_error 1 "Service health check"
            exit $DEPLOYMENT_EXIT_CODE
          fi
          
          # BACKOFF is temporary, give it time
          if echo "$SUPERVISOR_STATUS" | grep -q "BACKOFF"; then
            echo "‚ö†Ô∏è  Some services are in BACKOFF state"
            echo "‚è≥ Waiting additional 10 seconds..."
            sleep 10
            
            SUPERVISOR_STATUS=$(sudo supervisorctl status 2>&1)
            echo "$SUPERVISOR_STATUS"
            
            if echo "$SUPERVISOR_STATUS" | grep -qE "FATAL|EXITED"; then
              echo "‚ùå Services still not running"
              handle_error 1 "Service health check"
              exit $DEPLOYMENT_EXIT_CODE
            fi
          fi
          
          RUNNING_COUNT=$(echo "$SUPERVISOR_STATUS" | grep -c "RUNNING" || echo "0")
          echo "‚úÖ Services running: $RUNNING_COUNT"
          
          if [ "$RUNNING_COUNT" -lt 1 ]; then
            echo "‚ùå No services are running"
            handle_error 1 "Service health check"
            exit $DEPLOYMENT_EXIT_CODE
          fi

          # --------------------------------------------------
          # Create success tag
          # --------------------------------------------------
          if [ "$DEPLOYMENT_SUCCESS" = true ]; then
            echo ""
            echo "üè∑Ô∏è  Creating Success Tag"
            echo "-----------------------------------"
            
            cd "$APP_DIR"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            if git tag -a "deploy-success-$TIMESTAMP" -m "Successful deployment at $TIMESTAMP" 2>&1; then
              echo "‚úÖ Tag created: deploy-success-$TIMESTAMP"
            else
              echo "‚ö†Ô∏è  Failed to create tag, but deployment succeeded"
            fi
          fi

          # --------------------------------------------------
          # Final summary
          # --------------------------------------------------
          echo ""
          echo "==================================="
          if [ "$DEPLOYMENT_SUCCESS" = true ]; then
            echo "‚úÖ Deployment Completed Successfully"
          else
            echo "‚ùå Deployment Failed"
          fi
          echo "==================================="
          echo "üìÖ Completed at: $(date)"
          echo "üìå Previous commit: $PREVIOUS_COMMIT"
          echo "üìå New commit: $NEW_COMMIT"
          echo "üìä Services running: $RUNNING_COUNT"
          echo "==================================="
          
          # Exit with proper code
          exit $DEPLOYMENT_EXIT_CODE

    - name: Check deployment result
      if: always()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CULLINAR_ERP_EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.CULLINAR_ERP_EC2_SSH_KEY }}
        script: |
          echo "üìã Final deployment log (last 50 lines):"
          tail -50 /home/ubuntu/deploy.log
          
          echo ""
          echo "üìä Current supervisor status:"
          sudo supervisorctl status

    - name: Notify Slack on success
      if: success()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s" | head -c 100)
        COMMIT_SHA=$(git rev-parse --short HEAD)
        
        curl -X POST "$SLACK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "{
            \"attachments\": [{
              \"color\": \"good\",
              \"title\": \":rocket: Frappe Deployment SUCCESS\",
              \"fields\": [
                {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                {\"title\": \"Commit\", \"value\": \"$COMMIT_SHA\", \"short\": true},
                {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true},
                {\"title\": \"Message\", \"value\": \"$COMMIT_MSG\", \"short\": false}
              ],
              \"actions\": [
                {
                  \"type\": \"button\",
                  \"text\": \"üîô Rollback\",
                  \"url\": \"https://github.com/${{ github.repository }}/actions/workflows/rollback-frappe.yml\"
                }
              ],
              \"footer\": \"GitHub Actions\",
              \"ts\": $(date +%s)
            }]
          }"

    - name: Notify Slack on failure
      if: failure()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        curl -X POST "$SLACK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "{
            \"attachments\": [{
              \"color\": \"danger\",
              \"title\": \":x: Frappe Deployment FAILED\",
              \"text\": \"Check logs for details. Automatic rollback may have been attempted.\",
              \"fields\": [
                {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                {\"title\": \"Commit\", \"value\": \"$(git rev-parse --short HEAD)\", \"short\": true},
                {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true}
              ],
              \"actions\": [
                {
                  \"type\": \"button\",
                  \"text\": \"üìã View Logs\",
                  \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                },
                {
                  \"type\": \"button\",
                  \"text\": \"üîô Manual Rollback\",
                  \"url\": \"https://github.com/${{ github.repository }}/actions/workflows/rollback-frappe.yml\"
                }
              ],
              \"footer\": \"GitHub Actions\",
              \"ts\": $(date +%s)
            }]
          }"