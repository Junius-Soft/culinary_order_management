name: Deploy Frappe to EC2 (with Rollback Support)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for tagging

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      id: deploy
      with:
        host: ${{ secrets.CULLINAR_ERP_EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.CULLINAR_ERP_EC2_SSH_KEY }}
        port: 22
        command_timeout: 45m
        script_stop: false
        script: |
          #!/bin/bash
          set -e
          set -o pipefail

          exec > >(tee -a /home/ubuntu/deploy.log)
          exec 2>&1

          echo "==================================="
          echo "ðŸš€ Starting Frappe Deployment"
          echo "ðŸ“… Date: $(date)"
          echo "==================================="

          # Prevent parallel deployments
          LOCK_FILE="/tmp/frappe_deploy.lock"
          exec 9>"$LOCK_FILE"
          
          if ! flock -n 9; then
            echo "âŒ Another deployment is running"
            exit 1
          fi

          cleanup() {
            local exit_code=$?
            flock -u 9 2>/dev/null || true
            exit $exit_code
          }
          
          trap cleanup EXIT INT TERM

          # Retry helper
          retry() {
            local retries=$1
            local wait_time=$2
            shift 2
            local cmd="$*"

            for ((i=1; i<=retries; i++)); do
              if eval "$cmd"; then
                return 0
              fi
              if [ "$i" -lt "$retries" ]; then
                sleep "$wait_time"
              fi
            done
            return 1
          }

          # Pull latest code
          APP_DIR="/home/ubuntu/frappe-bench-test/apps/culinary_order_management"
          cd "$APP_DIR" || exit 1

          echo "ðŸ“¥ Pulling latest code..."
          
          # Save current commit for rollback
          PREVIOUS_COMMIT=$(git rev-parse HEAD)
          echo "ðŸ“Œ Previous commit: $PREVIOUS_COMMIT"

          git fetch upstream || git fetch origin
          git checkout main
          
          if git remote | grep -q "upstream"; then
            git pull upstream main || git pull origin main
          else
            git pull origin main
          fi

          NEW_COMMIT=$(git rev-parse HEAD)
          echo "ðŸ“Œ New commit: $NEW_COMMIT"

          # Build & migrate
          BENCH_DIR="/home/ubuntu/frappe-bench-test"
          cd "$BENCH_DIR" || exit 1

          echo "ðŸ—ï¸  Building assets..."
          if ! retry 3 60 "timeout 10m bench build --app culinary_order_management"; then
            echo "âŒ Build failed"
            cd "$APP_DIR"
            git checkout "$PREVIOUS_COMMIT"
            echo "ðŸ”™ Rolled back to previous commit"
            exit 1
          fi

          echo "ðŸ§¬ Running migrations..."
          if ! retry 3 60 "timeout 10m bench --site all migrate"; then
            echo "âŒ Migration failed"
            cd "$APP_DIR"
            git checkout "$PREVIOUS_COMMIT"
            retry 2 60 "timeout 10m bench build --app culinary_order_management"
            echo "ðŸ”™ Rolled back to previous commit"
            exit 1
          fi

          echo "ðŸ§¹ Clearing cache..."
          retry 2 30 "bench --site all clear-cache" || true

          # Restart services
          echo "ðŸ” Restarting services..."
          bench restart

          sleep 10

          echo "ðŸ“Š Supervisor status:"
          sudo supervisorctl status

          # Health check
          if sudo supervisorctl status | grep -qE "BACKOFF|FATAL|EXITED"; then
            echo "âŒ Services failed to start"
            sudo supervisorctl status | grep -E "BACKOFF|FATAL|EXITED" || true
            
            echo "ðŸ”™ Attempting automatic rollback..."
            cd "$APP_DIR"
            git checkout "$PREVIOUS_COMMIT"
            cd "$BENCH_DIR"
            retry 2 60 "bench build --app culinary_order_management"
            bench restart
            
            exit 1
          fi

          # Create success tag for future rollback
          cd "$APP_DIR"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          git tag -a "deploy-success-$TIMESTAMP" -m "Successful deployment at $TIMESTAMP"
          
          echo "ðŸ·ï¸  Created tag: deploy-success-$TIMESTAMP"

          echo ""
          echo "==================================="
          echo "âœ… Deployment Completed Successfully"
          echo "ðŸ“Œ Deployed commit: $NEW_COMMIT"
          echo "ðŸ·ï¸  Rollback tag: deploy-success-$TIMESTAMP"
          echo "==================================="

    - name: Notify Slack on success
      if: success()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:"%s" | head -c 100)
        COMMIT_SHA=$(git rev-parse --short HEAD)
        
        curl -X POST "$SLACK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "{
            \"attachments\": [{
              \"color\": \"good\",
              \"title\": \":rocket: Frappe Deployment SUCCESS\",
              \"fields\": [
                {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                {\"title\": \"Commit\", \"value\": \"$COMMIT_SHA\", \"short\": true},
                {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true},
                {\"title\": \"Message\", \"value\": \"$COMMIT_MSG\", \"short\": false}
              ],
              \"actions\": [
                {
                  \"type\": \"button\",
                  \"text\": \"ðŸ”™ Rollback\",
                  \"url\": \"https://github.com/${{ github.repository }}/actions/workflows/rollback-frappe.yml\"
                }
              ],
              \"footer\": \"GitHub Actions\",
              \"ts\": $(date +%s)
            }]
          }"

    - name: Notify Slack on failure
      if: failure()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        curl -X POST "$SLACK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "{
            \"attachments\": [{
              \"color\": \"danger\",
              \"title\": \":x: Frappe Deployment FAILED\",
              \"text\": \"Automatic rollback was attempted. Check logs for details.\",
              \"fields\": [
                {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                {\"title\": \"Commit\", \"value\": \"$(git rev-parse --short HEAD)\", \"short\": true},
                {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true}
              ],
              \"actions\": [
                {
                  \"type\": \"button\",
                  \"text\": \"ðŸ“‹ View Logs\",
                  \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                },
                {
                  \"type\": \"button\",
                  \"text\": \"ðŸ”™ Manual Rollback\",
                  \"url\": \"https://github.com/${{ github.repository }}/actions/workflows/rollback-frappe.yml\"
                }
              ],
              \"footer\": \"GitHub Actions\",
              \"ts\": $(date +%s)
            }]
          }"