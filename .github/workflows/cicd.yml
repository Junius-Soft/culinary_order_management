name: Deploy Frappe to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60  # Global timeout

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CULLINAR_ERP_EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.CULLINAR_ERP_EC2_SSH_KEY }}
        port: 22
        command_timeout: 45m
        script_stop: false  # Continue on error to capture logs
        script: |
          #!/bin/bash
          set -e
          set -o pipefail

          # Redirect all output to both console and log file
          exec > >(tee -a /home/ubuntu/deploy.log)
          exec 2>&1

          echo "==================================="
          echo "üöÄ Starting Frappe Deployment"
          echo "üìÖ Date: $(date)"
          echo "üë§ User: $(whoami)"
          echo "==================================="

          # --------------------------------------------------
          # Environment check
          # --------------------------------------------------
          echo ""
          echo "üîç Environment Check:"
          echo "-----------------------------------"
          echo "Working directory: $(pwd)"
          echo "Python version: $(python3 --version 2>&1 || echo 'Python not found')"
          echo "Node version: $(node --version 2>&1 || echo 'Node not found')"
          echo "Bench version: $(bench --version 2>&1 || echo 'Bench not found')"
          
          # Check if bench directory exists
          if [ ! -d "/home/ubuntu/frappe-bench-test" ]; then
            echo "‚ùå ERROR: Frappe bench directory not found!"
            exit 1
          fi

          # --------------------------------------------------
          # Prevent parallel deployments
          # --------------------------------------------------
          LOCK_FILE="/tmp/frappe_deploy.lock"
          exec 9>"$LOCK_FILE"
          
          if ! flock -n 9; then
            echo "‚ùå Another deployment is already running"
            echo "Lock file: $LOCK_FILE"
            exit 1
          fi
          
          echo "‚úÖ Deployment lock acquired"

          # Cleanup function
          cleanup() {
            local exit_code=$?
            echo ""
            echo "üßπ Cleanup function triggered (exit code: $exit_code)"
            
            # Release lock
            flock -u 9 2>/dev/null || true
            
            if [ $exit_code -ne 0 ]; then
              echo "‚ùå Deployment failed with exit code: $exit_code"
              echo "üìã Last 50 lines of log:"
              tail -50 /home/ubuntu/deploy.log
            fi
            
            exit $exit_code
          }
          
          trap cleanup EXIT INT TERM

          # --------------------------------------------------
          # Retry helper function
          # --------------------------------------------------
          retry() {
            local retries=$1
            local wait_time=$2
            shift 2
            local cmd="$*"

            for ((i=1; i<=retries; i++)); do
              echo ""
              echo "‚ñ∂Ô∏è  Attempt $i/$retries: $cmd"
              
              if eval "$cmd"; then
                echo "‚úÖ Command succeeded"
                return 0
              fi

              local last_exit_code=$?
              echo "‚ö†Ô∏è  Command failed with exit code: $last_exit_code"
              
              if [ "$i" -lt "$retries" ]; then
                echo "‚è≥ Waiting $wait_time seconds before retry..."
                sleep "$wait_time"
              fi
            done

            echo "‚ùå Command failed after $retries attempts"
            return 1
          }

          # --------------------------------------------------
          # Pull latest code
          # --------------------------------------------------
          echo ""
          echo "üì• Pulling Latest Code"
          echo "-----------------------------------"
          
          APP_DIR="/home/ubuntu/frappe-bench-test/apps/culinary_order_management"
          
          if [ ! -d "$APP_DIR" ]; then
            echo "‚ùå ERROR: App directory not found: $APP_DIR"
            exit 1
          fi
          
          cd "$APP_DIR" || exit 1
          echo "üìÇ Changed to: $(pwd)"

          echo "üîç Git status before pull:"
          git status --short || true

          echo ""
          echo "üì° Fetching from upstream..."
          if ! retry 3 10 "git fetch upstream"; then
            echo "‚ö†Ô∏è  Failed to fetch from upstream, trying origin..."
            retry 3 10 "git fetch origin" || {
              echo "‚ùå Failed to fetch from both upstream and origin"
              exit 1
            }
          fi

          echo ""
          echo "üîÄ Checking out main branch..."
          git checkout main || {
            echo "‚ùå Failed to checkout main branch"
            exit 1
          }

          echo ""
          echo "‚¨áÔ∏è  Pulling latest changes..."
          if git remote | grep -q "upstream"; then
            git pull upstream main || {
              echo "‚ö†Ô∏è  Failed to pull from upstream, trying origin..."
              git pull origin main || {
                echo "‚ùå Failed to pull from both upstream and origin"
                exit 1
              }
            }
          else
            git pull origin main || {
              echo "‚ùå Failed to pull from origin"
              exit 1
            }
          fi

          echo "‚úÖ Code updated successfully"
          echo "üìù Latest commit:"
          git log -1 --oneline

          # --------------------------------------------------
          # Build assets
          # --------------------------------------------------
          echo ""
          echo "üèóÔ∏è  Building Assets"
          echo "-----------------------------------"
          
          BENCH_DIR="/home/ubuntu/frappe-bench-test"
          cd "$BENCH_DIR" || exit 1
          echo "üìÇ Changed to: $(pwd)"

          # Check if bench command is available
          if ! command -v bench &> /dev/null; then
            echo "‚ùå ERROR: bench command not found"
            echo "Trying to use bench from virtual environment..."
            if [ -f "$BENCH_DIR/env/bin/bench" ]; then
              export PATH="$BENCH_DIR/env/bin:$PATH"
            else
              echo "‚ùå Virtual environment not found"
              exit 1
            fi
          fi

          echo "üî® Building app: culinary_order_management"
          
          # Build with retry and timeout
          if ! retry 3 60 "timeout 10m bench build --app culinary_order_management"; then
            echo "‚ùå Build failed after retries"
            echo "üìã Checking for build errors..."
            ls -la sites/assets/ 2>&1 || echo "Assets directory not accessible"
            exit 1
          fi
          
          echo "‚úÖ Build completed successfully"

          # --------------------------------------------------
          # Run migrations
          # --------------------------------------------------
          echo ""
          echo "üß¨ Running Migrations"
          echo "-----------------------------------"
          
          if ! retry 3 60 "timeout 10m bench --site all migrate"; then
            echo "‚ùå Migration failed after retries"
            echo "üìã Checking site status..."
            bench --site all list-apps 2>&1 || echo "Failed to list apps"
            exit 1
          fi
          
          echo "‚úÖ Migrations completed successfully"

          # --------------------------------------------------
          # Clear cache
          # --------------------------------------------------
          echo ""
          echo "üßπ Clearing Cache"
          echo "-----------------------------------"
          
          if ! retry 2 30 "bench --site all clear-cache"; then
            echo "‚ö†Ô∏è  Cache clearing failed, but continuing..."
          else
            echo "‚úÖ Cache cleared successfully"
          fi

          # --------------------------------------------------
          # Restart services
          # --------------------------------------------------
          echo ""
          echo "üîÅ Restarting Frappe Services"
          echo "-----------------------------------"
          
          echo "üõë Stopping services..."
          bench restart || {
            echo "‚ö†Ô∏è  bench restart failed, trying manual restart..."
            sudo supervisorctl restart all || {
              echo "‚ùå Failed to restart services"
              exit 1
            }
          }

          echo "‚è≥ Waiting for services to stabilize..."
          sleep 10

          echo ""
          echo "üìä Supervisor Status:"
          echo "-----------------------------------"
          sudo supervisorctl status || {
            echo "‚ö†Ô∏è  Could not get supervisor status"
          }

          # --------------------------------------------------
          # Health check
          # --------------------------------------------------
          echo ""
          echo "üè• Health Check"
          echo "-----------------------------------"
          
          sleep 5
          
          # Check for failed services
          if sudo supervisorctl status | grep -qE "BACKOFF|FATAL|EXITED"; then
            echo "‚ùå Some services are not running properly:"
            sudo supervisorctl status | grep -E "BACKOFF|FATAL|EXITED" || true
            
            echo ""
            echo "üìã Checking logs for failed services..."
            sudo tail -50 /var/log/supervisor/*.log 2>&1 || echo "Could not read supervisor logs"
            
            exit 1
          fi

          # Check if all expected services are running
          RUNNING_COUNT=$(sudo supervisorctl status | grep -c "RUNNING" || echo "0")
          echo "‚úÖ Services running: $RUNNING_COUNT"
          
          if [ "$RUNNING_COUNT" -lt 1 ]; then
            echo "‚ùå No services are running!"
            exit 1
          fi

          echo ""
          echo "==================================="
          echo "‚úÖ Deployment Completed Successfully"
          echo "üìÖ Completed at: $(date)"
          echo "==================================="

    - name: Upload deployment logs
      if: always()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CULLINAR_ERP_EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.CULLINAR_ERP_EC2_SSH_KEY }}
        script: |
          if [ -f /home/ubuntu/deploy.log ]; then
            echo "üìÑ Deployment log content:"
            tail -100 /home/ubuntu/deploy.log
          else
            echo "‚ö†Ô∏è  No deployment log found"
          fi

    - name: Send Slack notification with log
      if: always()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          STATUS_EMOJI=":white_check_mark:"
          STATUS_TEXT="SUCCESS"
          COLOR="good"
        else
          STATUS_EMOJI=":x:"
          STATUS_TEXT="FAILED"
          COLOR="danger"
        fi
        
        COMMIT_MSG=$(git log -1 --pretty=format:"%s" | head -c 100)
        COMMIT_SHA=$(git rev-parse --short HEAD)
        
        curl -X POST "$SLACK_WEBHOOK" \
          -H 'Content-Type: application/json' \
          -d "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"title\": \"$STATUS_EMOJI Frappe Deployment $STATUS_TEXT\",
              \"fields\": [
                {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                {\"title\": \"Commit\", \"value\": \"$COMMIT_SHA\", \"short\": true},
                {\"title\": \"Author\", \"value\": \"${{ github.actor }}\", \"short\": true},
                {\"title\": \"Duration\", \"value\": \"Started at $(date)\", \"short\": true},
                {\"title\": \"Message\", \"value\": \"$COMMIT_MSG\", \"short\": false}
              ],
              \"footer\": \"GitHub Actions\",
              \"ts\": $(date +%s)
            }]
          }"

    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}';
          const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `${emoji} **Deployment ${status}**\n\nBranch: \`${{ github.ref_name }}\`\nCommit: \`${{ github.sha }}\``
          });