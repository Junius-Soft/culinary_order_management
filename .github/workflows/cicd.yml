name: Deploy Frappe to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CULLINAR_ERP_EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.CULLINAR_ERP_EC2_SSH_KEY }}
        command_timeout: 45m
        envs: SLACK_TOKEN
        script: |
          (
          set -e

          echo "==================================="
          echo "üöÄ Starting Frappe Deployment"
          echo "==================================="

          # --------------------------------------------------
          # Prevent parallel deployments
          # --------------------------------------------------
          exec 9>/tmp/frappe_deploy.lock
          flock -n 9 || {
            echo "‚ùå Another deployment is running. Exiting."
            exit 1
          }

          # --------------------------------------------------
          # Retry helper
          # --------------------------------------------------
          retry() {
            local retries=$1
            local wait_time=$2
            shift 2
            local cmd="$@"

            for ((i=1; i<=retries; i++)); do
              echo "‚ñ∂Ô∏è Attempt $i/$retries: $cmd"
              if eval "$cmd"; then
                return 0
              fi

              echo "‚ö†Ô∏è Command failed."
              if [ "$i" -lt "$retries" ]; then
                echo "‚è≥ Waiting $wait_time seconds before retry..."
                sleep "$wait_time"
              fi
            done

            echo "‚ùå Command failed after $retries attempts"
            return 1
          }

          # --------------------------------------------------
          # Pull latest code
          # --------------------------------------------------
          cd /home/ubuntu/frappe-bench-test/apps/culinary_order_management

          echo "üì• Fetching latest code..."
          git fetch upstream
          git checkout main
          git pull upstream main

          # --------------------------------------------------
          # Build & migrate (with retry)
          # --------------------------------------------------
          cd /home/ubuntu/frappe-bench-test

          echo "üèóÔ∏è  Building assets..."
          retry 5 60 bench build --app culinary_order_management

          echo "üß¨ Running migrations..."
          retry 5 60 bench migrate

          echo "üßπ Clearing cache..."
          retry 3 30 bench --site all clear-cache

          # --------------------------------------------------
          # Restart services
          # --------------------------------------------------
          echo "üîÅ Restarting Frappe services..."
          bench restart

          echo ""
          echo "üìä Supervisor status:"
          sudo supervisorctl status

          echo "==================================="
          echo "‚úÖ Deployment completed successfully"
          echo "==================================="
          ) 2>&1 | tee /home/ubuntu/deploy.log

          # --------------------------------------------------
          # Health check
          # --------------------------------------------------
          sleep 5
          if sudo supervisorctl status | grep -q "BACKOFF\|FATAL"; then
            echo "‚ö†Ô∏è  Some services failed to start"
            sudo supervisorctl status | grep "BACKOFF\|FATAL"
            exit 1
          fi

          # --------------------------------------------------
          # Upload deploy log to Slack
          # --------------------------------------------------
          curl -F file=@/home/ubuntu/deploy.log \
            -F "initial_comment=üìÑ Frappe Deployment Log" \
            -F channels=your-slack-channel-id \
            -H "Authorization: Bearer $SLACK_TOKEN" \
            https://slack.com/api/files.upload

    - name: Notify Slack on success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\":white_check_mark: *Frappe Deploy SUCCESS* on *${{ github.ref_name }}*\"}" \
        ${{ secrets.SLACK_WEBHOOK }}

    - name: Notify Slack on failure
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\":x: *Frappe Deploy FAILED* on *${{ github.ref_name }}*\"}" \
        ${{ secrets.SLACK_WEBHOOK }}
